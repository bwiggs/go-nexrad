<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <script src="assets/js/coordinatesCalc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/geolib@3.3.1/lib/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script src="assets/js/pako.min.js"></script>
    <script src="assets/js/tiff.js"></script>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>

    <!-- https://github.com/CliffCloud/Leaflet.EasyButton -->
    <link rel="stylesheet" href="assets/css/easy-button.css" />
    <script src="assets/js/easy-button.js"></script>
    <!-- https://cdnjs.com/libraries/font-awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <style>
        #map {
            width: auto;
            height: 400px;
            position: absolute;
            text-align: center;
            left: 5%;
            right: 5%;
            bottom: 5%;
            border-style: solid;
            border-width: 2px;
            /* border-radius: 50%; */
            border-color: black;
        }
        .false-anchor {
            cursor: pointer;
            text-decoration: underline;
            color:rgb(0, 0, 238);
        }
        .icon-selected {
            color:rgb(0, 132, 255);
        }
        /* Leaflet crispness override 
        https://stackoverflow.com/a/69032144 */
        .leaflet-container .leaflet-overlay-pane svg,
        .leaflet-container .leaflet-marker-pane img,
        .leaflet-container .leaflet-shadow-pane img,
        .leaflet-container .leaflet-tile-pane img,
        .leaflet-container img.leaflet-image-layer {
            max-width: none !important;
            /* Preserve crisp pixels with scaled up images */
            image-rendering: optimizeSpeed;             /* Legal fallback */
            image-rendering: -moz-crisp-edges;          /* Firefox        */
            image-rendering: -o-crisp-edges;            /* Opera          */
            image-rendering: -webkit-optimize-contrast; /* Safari         */
            image-rendering: optimize-contrast;         /* CSS3 Proposed  */
            image-rendering: crisp-edges;               /* CSS4 Proposed  */
            image-rendering: pixelated;                 /* CSS4 Proposed  */
            -ms-interpolation-mode: nearest-neighbor;   /* IE8+           */
        }
    </style>
</head>

<body>
    <!-- <input id="image-file" type="file" accept="image/*"/> -->
    <input id="image-file" type="file" />
    <div>Station: (<a class="false-anchor" id="jumpToStation">KLWX</a>)</div>
    <input id="stationInput">
    <br>
    <button id="theSubmitter">Ok</button>
    <div id="statLat"></div>
    <div id="statLon"></div>
    <div style="display: none" id="squareBounds"></div>
    <div style="display: none" id="blobURL"></div>
    <script>
        document.getElementById('jumpToStation').addEventListener("click", function() {
            document.getElementById('stationInput').value = "KLWX";
            $('#theSubmitter').trigger('click');
        });
    </script>

    <div id="weathermap"><b>Please input a radar station.</b></div>

    <script>
        // 38.9761
		// -77.4875
        document.getElementById('theSubmitter').addEventListener("click", function() {
            document.getElementById('squareBounds').innerHTML = '';
            document.getElementById('blobURL').innerHTML = '';
            $.getJSON('https://steepatticstairs.github.io/weather/json/radarStations.json', function(data) {
                var formattedStation = document.getElementById('stationInput').value;
                formattedStation = formattedStation.toUpperCase().replace(/ /g, '');

                var stationLat = data[formattedStation][1];
                document.getElementById('statLat').innerHTML = stationLat;
                var stationLon = data[formattedStation][2];
                document.getElementById('statLon').innerHTML = stationLon;

                document.getElementById('weathermap').innerHTML = "<div id='map'></div>";

                var map = 
                L.map('map', {
                    renderer: L.svg(),
                    //attributionControl: false, // Disable the autogenerated attribution 
                    zoomControl: true,
                    //touchZoom: false,
                    zoomDelta: 0.5,
                    zoomSnap: 0.5,
                }).setView([stationLat, stationLon], 7);

                var osmLayer = 
                L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                //var nexradLayer = 
                //L.tileLayer.wms("https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi", {
                //    layers: 'nexrad-n0q-900913',
                //    format: 'image/png',
                //    transparent: true,
                //    attribution: "Weather data Â© 2012 IEM Nexrad",
                //    opacity: 0.6
                //}).addTo(map);

                //function wdgProduct(stationToShow, product, theOpacity) {
                //    var urlToGet = `https://opengeo.ncep.noaa.gov/geoserver/${stationToShow.toLowerCase()}/${stationToShow.toLowerCase()}_${product}/ows?`;
                //    var theService = `${stationToShow.toLowerCase()}_${product}`;
                //    var wdgProductLayer = 
                //    L.tileLayer.wms(urlToGet, {
                //        SERVICE: 'WMS',
                //        LAYERS: theService,
                //        format: 'image/png',
                //        transparent: true
                //    });
                //    wdgProductLayer.addTo(map);
                //    wdgProductLayer.setOpacity(theOpacity);
                //}
                //wdgProduct("KLWX", "bref_raw", 0.6);

                var allLayerGroup = L.layerGroup();
                var imageLayerGroup = L.layerGroup().addTo(map);

                //var marker = new L.Marker([38.9761, -77.4875]).addTo(map);

                map.on('zoomstart', function() {
                    allLayerGroup.clearLayers();
                    map.eachLayer(function (layer) {
                        if (layer != osmLayer) {
                            map.removeLayer(layer);
                            allLayerGroup.addLayer(layer);
                        }
                    });
                });
                map.on('zoomend', function() {
                    allLayerGroup.eachLayer(function (layer) {
                        map.addLayer(layer);
                    });
                });

                var imageButton = 
                L.easyButton({
                    states: [{
                        icon: '<span class="fa fa-image" id="faImageSpan" style="line-height:28px"></span>',
                        stateName: 'add',
                        onClick: function(control) {
                            //showImage(stationLat, stationLon, 'circleWithCenter.svg')
                            // URL.createObjectURL(document.getElementById("image-file").files[0])
                            // '../cmd/nexrad-render/radar.png'

                            // https://mrms.ncep.noaa.gov/data/RIDGEII/L2/KLWX/BREF_RAW/
                            function un_gzip_uploaded_file() {
                                var reader = new FileReader();
                                reader.onload = function(){
                                    // https://stackoverflow.com/a/22675494
                                    var arrayBuffer = this.result;
                                    console.log(arrayBuffer);
                                    // Get datastream as Array, for example:
                                    var charData = arrayBuffer;
                                    // Turn number array into byte-array
                                    var binData = new Uint8Array(charData);
                                    // Pako magic
                                    var data = pako.inflate(binData);
                                    // Output to console
                                    var blob = new Blob([new Uint8Array(data).buffer])
                                    var blobURL = URL.createObjectURL(blob)
                                    //console.log(blobURL);

                                    var xhr = new XMLHttpRequest();
                                    xhr.responseType = 'arraybuffer';
                                    xhr.open('GET', blobURL);
                                    xhr.onload = function (e) {
                                        var tiff = new Tiff({buffer: xhr.response});
                                        var canvas = tiff.toCanvas();
                                        canvas.toBlob(function(blob) {
                                            const newImg = document.createElement('img');
                                            const url2 = URL.createObjectURL(blob);
                                            document.getElementById('blobURL').innerHTML = url2;
                                            setImageFromCenter(950, document.getElementById('blobURL').innerHTML, stationLat, stationLon, 7)
                                        })
                                    };
                                    xhr.send();
                                }
                                reader.readAsArrayBuffer(document.getElementById("image-file").files[0]);
                            }
                            var blobUrlElem = document.getElementById('blobURL');
                            if (blobUrlElem.innerHTML == '') {
                                un_gzip_uploaded_file()
                            } else if (blobUrlElem.innerHTML != '') {
                                setImageFromCenter(950, blobUrlElem.innerHTML, stationLat, stationLon, 7)
                            }
                            //setImageFromCenter(950, imageURLToDisplay, stationLat, stationLon, 7)
                            control.state('remove');
                        }
                    }, {
                        icon: '<span class="fa fa-image icon-selected" id="faImageSpan" style="line-height:28px"></span>',
                        stateName: 'remove',
                        onClick: function(control) {
                            imageLayerGroup.clearLayers();
                            control.state('add');
                        },
                    }],
                        //tagName: 'a'
                }).addTo(map);

                function setImageFromCenter(zoomLevel, imagePath, lat, lng, zoom) {
                    var initMapCenter = map.getCenter();
                    var initMapZoom = map.getZoom();
                    var initMapWidth = document.getElementById("map").style.width;
                    var initMapHeight = document.getElementById("map").style.height;

                    //map.setView([lat, lng], zoom, {
                    //    "animate": false
                    //});

                    // sets the map's width and height to be the same as the user's value
                    $("#map").css("width", zoomLevel + "px");
                    $("#map").css("height", zoomLevel + "px");
                    map.invalidateSize();

                    // sets the image overlay to the map's bounds
                    var squareBoundsElem = document.getElementById('squareBounds');
                    if (squareBoundsElem.innerHTML == '') {
                        map.setView([lat, lng], zoom, {"animate": false});
                        var theSquareBounds = map.getBounds();
                        squareBoundsElem.innerHTML = JSON.stringify(theSquareBounds);
                        L.imageOverlay(imagePath, theSquareBounds).addTo(imageLayerGroup);
                        map.setView(initMapCenter, initMapZoom, {"animate": false});
                    } else if (squareBoundsElem.innerHTML != '') {
                        var parsedStoredBounds = JSON.parse(squareBoundsElem.innerHTML);
                        console.log(parsedStoredBounds)
                        var theParsedBounds = [[parsedStoredBounds._southWest.lat, parsedStoredBounds._southWest.lng], [parsedStoredBounds._northEast.lat, parsedStoredBounds._northEast.lng]]
                        L.imageOverlay(imagePath, theParsedBounds).addTo(imageLayerGroup);
                    }

                    // resets the map's initial dimensions
                    $("#map").css("height", initMapHeight);
                    $("#map").css("width", "auto");
                    map.invalidateSize();

                    //map.setView(initMapCenter, initMapZoom, {
                    //    "animate": false
                    //});
                }
            })
        });








        /*
        * THIS IS ALL TEST CODE TO GENERATE A JSON FILE
        * https://steepatticstairs.github.io/weather/json/boundingBoxes.json
        */
        function makeObjectOfBBOX() {
            var statArray = [];
            var fullObj = {};
            $.getJSON('https://steepatticstairs.github.io/weather/json/wdg_radar-stations_05042022.json', function(data) {
                var i = 1;
                function myLoop() {
                    setTimeout(function() {
                        var stationType = data.features[i].properties.stationType;
                        if (stationType == "WSR-88D") {
                            var currentStation = data.features[i].properties.id;
                            statArray.push(currentStation);
                            document.getElementById('stationInput').value = currentStation;
                            $('#theSubmitter').trigger('click');
                            //setImageFromCenter(950, 'radar.png', stationLat, stationLon, 7);
                            setTimeout(() => {
                                var parsedStoredBounds = JSON.parse(document.getElementById('squareBounds').innerHTML);
                                var lat_min = parsedStoredBounds._southWest.lat
                                var lat_max = parsedStoredBounds._northEast.lat
                                var lon_min = parsedStoredBounds._southWest.lng
                                var lon_max = parsedStoredBounds._northEast.lng

                                fullObj[currentStation] = [lat_min, lat_max, lon_min, lon_max];
                                console.log(fullObj)
                            }, 1000);
                        }
                        i++;
                        if (i < 208) {
                            console.log(i)
                            myLoop();
                        }
                    }, 2000)
                }
                myLoop();
                //console.log(statArray.sort())
                if (i == 208) {
                    //console.log(f)
                }
            });
        }
        //makeObjectOfBBOX();
    </script>
</body>
</html>